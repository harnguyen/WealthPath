name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/wealthpath
            sudo git config --global --add safe.directory /opt/wealthpath
            sudo git pull origin main
            sudo docker compose -f docker-compose.deploy.yaml pull
            sudo docker compose -f docker-compose.deploy.yaml up -d
            sudo docker image prune -f
            
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            echo "üìä Container Status:"
            sudo docker compose -f docker-compose.deploy.yaml ps
            
            echo ""
            echo "üîç Health Checks:"
            
            # Check backend health (via docker exec since port not exposed to host)
            if sudo docker exec wealthpath-backend-1 wget -qO- http://localhost:8080/api/health 2>/dev/null | grep -q "ok"; then
              echo "‚úÖ Backend: healthy"
            else
              echo "‚ùå Backend: unhealthy"
              sudo docker logs wealthpath-backend-1 --tail 20
              exit 1
            fi
            
            # Check frontend (via docker exec)
            if sudo docker exec wealthpath-frontend-1 wget -qO- http://localhost:3000 2>/dev/null; then
              echo "‚úÖ Frontend: healthy"
            else
              echo "‚ùå Frontend: unhealthy"
              sudo docker logs wealthpath-frontend-1 --tail 20
              exit 1
            fi
            
            # Check postgres
            if sudo docker exec wealthpath-postgres-1 pg_isready -U wealthpath > /dev/null 2>&1; then
              echo "‚úÖ Postgres: healthy"
            else
              echo "‚ùå Postgres: unhealthy"
              exit 1
            fi
            
            echo ""
            echo "‚úÖ Deployment successful at $(date)"

