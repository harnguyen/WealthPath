---
# WealthPath Deployment Playbook
# Usage: ansible-playbook playbook.yml
# With vault: ansible-playbook playbook.yml --ask-vault-pass

- name: Deploy WealthPath
  hosts: wealthpath
  become: yes
  
  vars:
    docker_compose_version: "2.24.0"
    postgres_user: "wealthpath"
    postgres_db: "wealthpath"
  
  pre_tasks:
    - name: Check if secrets.yml exists
      local_action: stat path=secrets.yml
      register: secrets_file
      become: no

    - name: Include secrets if available
      include_vars: secrets.yml
      when: secrets_file.stat.exists
      no_log: true

  tasks:
    # ============================================
    # System Setup
    # ============================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - git
          - jq
          - python3-pip
          - gnupg
          - lsb-release
        state: present

    # ============================================
    # Docker Installation
    # ============================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # ============================================
    # PostgreSQL Installation
    # ============================================
    - name: Check if .env exists for password
      stat:
        path: "{{ app_dir }}/.env"
      register: env_file_check

    - name: Generate Postgres password if needed
      set_fact:
        postgres_password: "{{ lookup('password', '/dev/null length=32 chars=hexdigits') }}"
      when: not env_file_check.stat.exists

    - name: Read existing Postgres password
      slurp:
        src: "{{ app_dir }}/.env"
      register: existing_env_check
      when: env_file_check.stat.exists

    - name: Parse existing Postgres password
      set_fact:
        postgres_password: "{{ existing_env_check.content | b64decode | regex_search('POSTGRES_PASSWORD=(.+)', '\\1') | first }}"
      when: env_file_check.stat.exists and existing_env_check.content is defined
      ignore_errors: yes

    - name: Install PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present
        update_cache: yes

    - name: Start PostgreSQL service
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: Wait for PostgreSQL to be ready
      wait_for:
        port: 5432
        host: localhost
        delay: 5
        timeout: 30

    - name: Check if database exists
      become_user: postgres
      command: psql -lqt | cut -d \| -f 1 | grep -qw "{{ postgres_db }}"
      register: db_exists
      changed_when: false
      failed_when: false

    - name: Create PostgreSQL database
      become_user: postgres
      postgresql_db:
        name: "{{ postgres_db }}"
        state: present
      when: not db_exists.rc == 0

    - name: Check if user exists
      become_user: postgres
      command: psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'"
      register: user_exists
      changed_when: false
      failed_when: false

    - name: Create PostgreSQL user
      become_user: postgres
      postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        priv: "{{ postgres_db }}:ALL"
        state: present
      when: not user_exists.rc == 0

    - name: Update PostgreSQL user password
      become_user: postgres
      postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        priv: "{{ postgres_db }}:ALL"
        state: present
      when: user_exists.rc == 0

    - name: Get PostgreSQL version
      command: psql --version
      register: postgres_version_result
      changed_when: false

    - name: Extract PostgreSQL major version
      set_fact:
        postgres_major_version: "{{ postgres_version_result.stdout | regex_search('([0-9]+)\\.[0-9]+') | first }}"

    - name: Configure PostgreSQL to accept connections from Docker
      lineinfile:
        path: "/etc/postgresql/{{ postgres_major_version }}/main/postgresql.conf"
        regexp: "^#?listen_addresses"
        line: "listen_addresses = '*'"
        backup: yes
      notify: restart postgresql

    - name: Configure PostgreSQL host-based authentication for Docker
      lineinfile:
        path: "/etc/postgresql/{{ postgres_major_version }}/main/pg_hba.conf"
        line: "host    {{ postgres_db }}    {{ postgres_user }}    172.16.0.0/12    md5"
        regexp: "^host.*{{ postgres_db }}.*{{ postgres_user }}.*172"
        state: present
        backup: yes
      notify: restart postgresql

    - name: Configure PostgreSQL to accept localhost connections
      lineinfile:
        path: "/etc/postgresql/{{ postgres_major_version }}/main/pg_hba.conf"
        line: "host    {{ postgres_db }}    {{ postgres_user }}    127.0.0.1/32    md5"
        regexp: "^host.*{{ postgres_db }}.*{{ postgres_user }}.*127"
        state: present
        backup: yes
      notify: restart postgresql

    # ============================================
    # Application Setup
    # ============================================
    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Clone/update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes
      become_user: ubuntu

    # ============================================
    # Get Server Info
    # ============================================
    - name: Get public IP
      uri:
        url: http://169.254.169.254/latest/meta-data/public-ipv4
        return_content: yes
      register: public_ip_result
      ignore_errors: yes

    - name: Set public IP fact
      set_fact:
        server_ip: "{{ public_ip_result.content | default(ansible_facts['default_ipv4']['address']) }}"

    - name: Generate sslip.io domain
      set_fact:
        auto_domain: "{{ server_ip | replace('.', '-') }}.sslip.io"

    - name: Set final domain
      set_fact:
        final_domain: "{{ domain if domain != '' else auto_domain }}"
        protocol: "{{ 'https' if use_ssl == 'true' else 'http' }}"

    - name: Set ACME CA for ZeroSSL
      set_fact:
        acme_ca: "{{ 'https://acme.zerossl.com/v2/DV90' if (use_zerossl == 'true' and use_ssl == 'true') else '' }}"

    # ============================================
    # Environment Configuration
    # ============================================
    - name: Check if .env exists
      stat:
        path: "{{ app_dir }}/.env"
      register: env_file

    - name: Generate JWT secret if needed
      set_fact:
        jwt_secret: "{{ lookup('password', '/dev/null length=64 chars=hexdigits') }}"
      when: not env_file.stat.exists

    - name: Read existing JWT secret
      slurp:
        src: "{{ app_dir }}/.env"
      register: existing_env
      when: env_file.stat.exists

    - name: Parse existing JWT secret
      set_fact:
        jwt_secret: "{{ existing_env.content | b64decode | regex_search('JWT_SECRET=(.+)', '\\1') | first }}"
      when: env_file.stat.exists and existing_env.content is defined
      ignore_errors: yes

    - name: Create .env file
      template:
        src: templates/env.j2
        dest: "{{ app_dir }}/.env"
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    # ============================================
    # Deploy Application
    # ============================================
    - name: Pull Docker images
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        pull: always
        state: present
      # Run as root since ubuntu user needs re-login for docker group

    - name: Start services
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        state: present
      register: compose_result

    # ============================================
    # Health Checks
    # ============================================
    - name: Wait for backend to be ready
      command: docker exec wealthpath-backend-1 wget -qO- http://localhost:8080/api/health
      register: backend_health
      retries: 30
      delay: 5
      until: backend_health.rc == 0
      changed_when: false

    - name: Display deployment info
      debug:
        msg: |
          
          âœ… WealthPath deployed successfully!
          
          URL: {{ protocol }}://{{ final_domain }}
          IP:  {{ server_ip }}
          
          SSH: ssh -i ~/.ssh/wealthpath_key ubuntu@{{ server_ip }}

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted

