---
# PostgreSQL Installation and Configuration Tasks
# Order: Install → Configure → Create Database → Create User

# =============================================================================
# PHASE 1: Installation
# =============================================================================

- name: Install PostgreSQL
  ansible.builtin.apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: yes

- name: Start PostgreSQL service
  ansible.builtin.systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Wait for PostgreSQL to be ready
  ansible.builtin.wait_for:
    port: 5432
    host: localhost
    delay: 5
    timeout: 30

# =============================================================================
# PHASE 2: Configuration (before creating DB/user)
# =============================================================================

- name: Get PostgreSQL major version
  ansible.builtin.shell: psql --version | awk '{print $3}' | cut -d. -f1
  register: postgres_version
  changed_when: false

- name: Configure PostgreSQL to listen on all interfaces (for Docker access)
  community.postgresql.postgresql_set:
    name: listen_addresses
    value: "*"
  become_user: postgres
  notify: restart postgresql

- name: Configure PostgreSQL to allow local connections
  community.postgresql.postgresql_pg_hba:
    dest: "/etc/postgresql/{{ postgres_version.stdout }}/main/pg_hba.conf"
    contype: host
    databases: all
    users: all
    address: 127.0.0.1/32
    method: md5
    state: present
    backup: yes
  notify: restart postgresql

- name: Allow Docker network connections in pg_hba.conf
  community.postgresql.postgresql_pg_hba:
    dest: "/etc/postgresql/{{ postgres_version.stdout }}/main/pg_hba.conf"
    contype: host
    databases: all
    users: all
    address: 172.17.0.0/16
    method: md5
    state: present
    backup: yes
    comment: "Docker container access"
  notify: restart postgresql

- name: Flush handlers to apply PostgreSQL config changes
  ansible.builtin.meta: flush_handlers

# =============================================================================
# PHASE 3: Database Setup
# =============================================================================

- name: Create PostgreSQL database
  community.postgresql.postgresql_db:
    name: "{{ postgres_db }}"
    state: present
  become_user: postgres

# =============================================================================
# PHASE 4: User Provisioning (after database is ready)
# =============================================================================

- name: Ensure postgres_password is defined
  ansible.builtin.fail:
    msg: "postgres_password is not defined. Ensure secrets are generated in pre_tasks."
  when: postgres_password is not defined

- name: Create PostgreSQL user
  community.postgresql.postgresql_user:
    name: "{{ postgres_user }}"
    password: "{{ postgres_password }}"
    state: present
  become_user: postgres
  no_log: true

- name: Grant user access to database
  community.postgresql.postgresql_privs:
    database: "{{ postgres_db }}"
    privs: ALL
    type: database
    role: "{{ postgres_user }}"
    state: present
  become_user: postgres

- name: Grant user schema privileges
  community.postgresql.postgresql_privs:
    database: "{{ postgres_db }}"
    privs: ALL
    type: schema
    objs: public
    role: "{{ postgres_user }}"
    state: present
  become_user: postgres
